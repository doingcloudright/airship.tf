<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Preparation | Airship Modules</title>
    <meta name="description" content="Flexible Terraform templates help setting up your Docker Orchestration platform, resources 100% supported by Amazon">
    
    
    <link rel="preload" href="/airship.tf/assets/css/0.styles.c084f234.css" as="style"><link rel="preload" href="/airship.tf/assets/js/app.4cee3cc5.js" as="script"><link rel="preload" href="/airship.tf/assets/js/20.c5c3716d.js" as="script"><link rel="preload" href="/airship.tf/assets/js/4.47100ef6.js" as="script"><link rel="prefetch" href="/airship.tf/assets/js/1.965ea306.js"><link rel="prefetch" href="/airship.tf/assets/js/10.06dee672.js"><link rel="prefetch" href="/airship.tf/assets/js/11.28d6581f.js"><link rel="prefetch" href="/airship.tf/assets/js/12.eb597dd5.js"><link rel="prefetch" href="/airship.tf/assets/js/13.d2c0c577.js"><link rel="prefetch" href="/airship.tf/assets/js/14.eec9b810.js"><link rel="prefetch" href="/airship.tf/assets/js/15.147d7810.js"><link rel="prefetch" href="/airship.tf/assets/js/16.18ebfa36.js"><link rel="prefetch" href="/airship.tf/assets/js/17.d163eb79.js"><link rel="prefetch" href="/airship.tf/assets/js/2.07fac88e.js"><link rel="prefetch" href="/airship.tf/assets/js/21.f34d5b4a.js"><link rel="prefetch" href="/airship.tf/assets/js/22.3c8f8f25.js"><link rel="prefetch" href="/airship.tf/assets/js/23.67dd923d.js"><link rel="prefetch" href="/airship.tf/assets/js/24.dd4a7491.js"><link rel="prefetch" href="/airship.tf/assets/js/25.7ec91b0b.js"><link rel="prefetch" href="/airship.tf/assets/js/26.d04e78c1.js"><link rel="prefetch" href="/airship.tf/assets/js/27.5afa5ae2.js"><link rel="prefetch" href="/airship.tf/assets/js/28.019b8d38.js"><link rel="prefetch" href="/airship.tf/assets/js/29.0ab72ade.js"><link rel="prefetch" href="/airship.tf/assets/js/3.45ad0597.js"><link rel="prefetch" href="/airship.tf/assets/js/30.3ab445cb.js"><link rel="prefetch" href="/airship.tf/assets/js/31.e2405844.js"><link rel="prefetch" href="/airship.tf/assets/js/32.a45f980f.js"><link rel="prefetch" href="/airship.tf/assets/js/33.532d1160.js"><link rel="prefetch" href="/airship.tf/assets/js/34.b30eeb32.js"><link rel="prefetch" href="/airship.tf/assets/js/35.9fa3ec65.js"><link rel="prefetch" href="/airship.tf/assets/js/36.b2b1fdd5.js"><link rel="prefetch" href="/airship.tf/assets/js/37.526a455a.js"><link rel="prefetch" href="/airship.tf/assets/js/38.7c311cbd.js"><link rel="prefetch" href="/airship.tf/assets/js/39.79e10685.js"><link rel="prefetch" href="/airship.tf/assets/js/40.81e3d38e.js"><link rel="prefetch" href="/airship.tf/assets/js/41.ada57e2d.js"><link rel="prefetch" href="/airship.tf/assets/js/42.b53f97fd.js"><link rel="prefetch" href="/airship.tf/assets/js/43.522e7415.js"><link rel="prefetch" href="/airship.tf/assets/js/44.faa0ea91.js"><link rel="prefetch" href="/airship.tf/assets/js/45.b12c9c87.js"><link rel="prefetch" href="/airship.tf/assets/js/5.5f33e6ff.js"><link rel="prefetch" href="/airship.tf/assets/js/6.b876cc7d.js"><link rel="prefetch" href="/airship.tf/assets/js/7.9de6e1cc.js"><link rel="prefetch" href="/airship.tf/assets/js/8.72121fe3.js"><link rel="prefetch" href="/airship.tf/assets/js/9.f18940a9.js"><link rel="prefetch" href="/airship.tf/assets/js/vendors~docsearch.259d7d1e.js">
    <link rel="stylesheet" href="/airship.tf/assets/css/0.styles.c084f234.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/airship.tf/" class="home-link router-link-active"><img src="/airship.tf/airship.png" alt="Airship Modules" class="logo"> <span class="site-name can-hide">Airship Modules</span></a> <div class="links"><form id="search-form" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/airship.tf/" class="nav-link">Home</a></div><div class="nav-item"><a href="/airship.tf/introduction/" class="nav-link">Introduction</a></div><div class="nav-item"><a href="/airship.tf/getting_started/" class="nav-link">Getting Started</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Guide</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Start</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/airship.tf/guide/ecs_cluster/" class="nav-link">ECS Cluster</a></li><li class="dropdown-subitem"><a href="/airship.tf/guide/ecs_service/" class="nav-link">ECS Service</a></li></ul></li></ul></div></div> <a href="https://github.com/blinkist/terraform-aws-airship-ecs-service" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/airship.tf/" class="nav-link">Home</a></div><div class="nav-item"><a href="/airship.tf/introduction/" class="nav-link">Introduction</a></div><div class="nav-item"><a href="/airship.tf/getting_started/" class="nav-link">Getting Started</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Guide</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Start</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/airship.tf/guide/ecs_cluster/" class="nav-link">ECS Cluster</a></li><li class="dropdown-subitem"><a href="/airship.tf/guide/ecs_service/" class="nav-link">ECS Service</a></li></ul></li></ul></div></div> <a href="https://github.com/blinkist/terraform-aws-airship-ecs-service" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </div> <div class="page"> <div class="content default"><h1 id="preparation"><a href="#preparation" aria-hidden="true" class="header-anchor">#</a> Preparation</h1> <h2 id="vpc"><a href="#vpc" aria-hidden="true" class="header-anchor">#</a> VPC</h2> <p>For ECS to work it needs a Virtual Private Cloud to run in, there are many proper pre-built Modules which create a VPC and everything related.
Good examples are <a href="https://github.com/cloudposse/terraform-aws-vpc" target="_blank" rel="noopener noreferrer">Cloudposse<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="https://github.com/terraform-aws-modules/terraform-aws-vpc" target="_blank" rel="noopener noreferrer">terraform-aws-modules<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> . For this example we use the latter. It's good practice to create public and private subnets, load balancers will reside in the public subnet, the ECS services will be in the private subnets.</p> <div class="language-json extra-class"><pre class="language-json"><code># VPC Definition
module <span class="token string">&quot;vpc&quot;</span> <span class="token punctuation">{</span>
  source  = <span class="token string">&quot;terraform-aws-modules/vpc/aws&quot;</span>
  version = <span class="token string">&quot;1.46.0&quot;</span>

  name = <span class="token string">&quot;ecs-vpc&quot;</span>
  cidr = <span class="token string">&quot;10.50.0.0/16&quot;</span>

  azs             = <span class="token punctuation">[</span><span class="token string">&quot;eu-central-1a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;eu-central-1b&quot;</span><span class="token punctuation">]</span>
  public_subnets  = <span class="token punctuation">[</span><span class="token string">&quot;10.50.11.0/24&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10.50.12.0/24&quot;</span><span class="token punctuation">]</span>
  private_subnets = <span class="token punctuation">[</span><span class="token string">&quot;10.50.21.0/24&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10.50.22.0/24&quot;</span><span class="token punctuation">]</span>

  single_nat_gateway = <span class="token boolean">true</span>

  enable_nat_gateway   = <span class="token boolean">true</span>
  enable_vpn_gateway   = <span class="token boolean">false</span>
  enable_dns_hostnames = <span class="token boolean">true</span>

  tags = <span class="token punctuation">{</span>
    Terraform   = <span class="token string">&quot;true&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="security-groups"><a href="#security-groups" aria-hidden="true" class="header-anchor">#</a> Security Groups</h2> <p>ECS will have network components just like EC2, for this example we need a security group for the load balancer, and one for the ecs service. In this example the load balancer allows traffic to HTTP and HTTPS and is allowed all outgoing traffic.</p> <div class="language-json extra-class"><pre class="language-json"><code>resource <span class="token string">&quot;aws_security_group&quot;</span> <span class="token string">&quot;lb_sg&quot;</span> <span class="token punctuation">{</span>
  name        = <span class="token string">&quot;load-balancer-sg&quot;</span>
  description = <span class="token string">&quot;Allow all inbound traffic to http and https&quot;</span>
  vpc_id      = <span class="token string">&quot;${module.vpc.vpc_id}&quot;</span>

  ingress <span class="token punctuation">{</span>
    from_port    = <span class="token number">80</span>
    to_port      = <span class="token number">80</span>
    protocol     = <span class="token string">&quot;tcp&quot;</span>
    cidr_blocks  = <span class="token punctuation">[</span><span class="token string">&quot;0.0.0.0/0&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  ingress <span class="token punctuation">{</span>
    from_port    = <span class="token number">443</span>
    to_port      = <span class="token number">443</span>
    protocol     = <span class="token string">&quot;tcp&quot;</span>
    cidr_blocks  = <span class="token punctuation">[</span><span class="token string">&quot;0.0.0.0/0&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  egress <span class="token punctuation">{</span>
    from_port   = <span class="token number">0</span>
    to_port     = <span class="token number">0</span>
    protocol    = <span class="token string">&quot;-1&quot;</span>
    cidr_blocks = <span class="token punctuation">[</span><span class="token string">&quot;0.0.0.0/0&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  tags <span class="token punctuation">{</span>
    Name = <span class="token string">&quot;load-balancer-sg&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The security group <code>fargate-ecs-service-sg</code> only allows incoming traffic on port 80 coming from the Load Balancer security group and has no restrictions outgoing.</p> <div class="language-json extra-class"><pre class="language-json"><code>resource <span class="token string">&quot;aws_security_group&quot;</span> <span class="token string">&quot;ecs_service_sg&quot;</span> <span class="token punctuation">{</span>
  name        = <span class="token string">&quot;fargate-ecs-service-sg&quot;</span>
  description = <span class="token string">&quot;Allow all inbound traffic to service port&quot;</span>
  vpc_id      = <span class="token string">&quot;${module.vpc.vpc_id}&quot;</span>

  ingress <span class="token punctuation">{</span>
    from_port       = <span class="token number">80</span>
    to_port         = <span class="token number">80</span>
    protocol        = <span class="token string">&quot;tcp&quot;</span>
    security_groups = <span class="token punctuation">[</span><span class="token string">&quot;${aws_security_group.lb_sg.id}&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  egress <span class="token punctuation">{</span>
    from_port   = <span class="token number">0</span>
    to_port     = <span class="token number">0</span>
    protocol    = <span class="token string">&quot;-1&quot;</span>
    cidr_blocks = <span class="token punctuation">[</span><span class="token string">&quot;0.0.0.0/0&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  tags <span class="token punctuation">{</span>
    Name = <span class="token string">&quot;fargate-ecs-service-sg&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="route53-zone"><a href="#route53-zone" aria-hidden="true" class="header-anchor">#</a> Route53 Zone</h2> <p>The ECS Service module by default creates a subdomain in the given zone by the following pattern [name].[domain]. This can be disabled but for this example we will use it. In the preparation step we use a datasource to make sure the zone is there.</p> <div class="language-json extra-class"><pre class="language-json"><code>data <span class="token string">&quot;aws_route53_zone&quot;</span> <span class="token string">&quot;zone&quot;</span> <span class="token punctuation">{</span>
  name  = <span class="token string">&quot;yourdomain_at_route53.com.&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>This module will create a record inside your existing zone, make sure that there is no overlap with existing records. If you create the certificate, it is best to use DNS validation.</p></div> <h2 id="application-load-balancer"><a href="#application-load-balancer" aria-hidden="true" class="header-anchor">#</a> Application Load Balancer</h2> <p>The ECS Service module can add many ECS Services to the same Application Load Balancer (ALB) by creating hostname based listener rules. For this module to operate with an ALB we need to setup one. We setup a loggin bucket first to make sure the ALB can log to S3.</p> <div class="language-json extra-class"><pre class="language-json"><code>module <span class="token string">&quot;lb_s3_bucket&quot;</span> <span class="token punctuation">{</span>
  source        = <span class="token string">&quot;cloudposse/lb-s3-bucket/aws&quot;</span>
  version       = <span class="token string">&quot;0.1.4&quot;</span>
  namespace     = <span class="token string">&quot;dcr&quot;</span>
  stage         = <span class="token string">&quot;test&quot;</span>
  name          = <span class="token string">&quot;lb-s3-bucket&quot;</span>
  region        = <span class="token string">&quot;&lt;YOUR REGION&gt;&quot;</span>
  force_destroy = <span class="token string">&quot;true&quot;</span>
<span class="token punctuation">}</span>

module <span class="token string">&quot;alb_shared_services_external&quot;</span> <span class="token punctuation">{</span>
    source                    = <span class="token string">&quot;terraform-aws-modules/alb/aws&quot;</span>
    version                   = <span class="token string">&quot;3.4.0&quot;</span>
    load_balancer_name        = <span class="token string">&quot;ecs-external&quot;</span>
    security_groups           = <span class="token punctuation">[</span><span class="token string">&quot;${aws_security_group.lb_sg.id}&quot;</span><span class="token punctuation">]</span>
    load_balancer_is_internal = <span class="token boolean">false</span>
    log_bucket_name           = <span class="token string">&quot;${module.lb_s3_bucket.bucket_id}&quot;</span>
    log_location_prefix       = <span class="token string">&quot;&quot;</span>
    subnets                   = <span class="token punctuation">[</span><span class="token string">&quot;${module.vpc.public_subnets}&quot;</span><span class="token punctuation">]</span>
    tags                      = <span class="token string">&quot;${map(&quot;</span>Environment<span class="token string">&quot;, &quot;</span>ECS Test Setup<span class="token string">&quot;)}&quot;</span>
    vpc_id                    = <span class="token string">&quot;${module.vpc.vpc_id}&quot;</span>
    https_listeners           = <span class="token string">&quot;&quot;</span>
    https_listeners_count     = <span class="token string">&quot;0&quot;</span>
    http_tcp_listeners        = <span class="token string">&quot;${list(map(&quot;</span>port<span class="token string">&quot;, &quot;</span><span class="token number">80</span><span class="token string">&quot;, &quot;</span>protocol<span class="token string">&quot;, &quot;</span>HTTP<span class="token string">&quot;))}&quot;</span>
    http_tcp_listeners_count  = <span class="token string">&quot;1&quot;</span>
    target_groups             = <span class="token string">&quot;${list(map(&quot;</span>name<span class="token string">&quot;, &quot;</span>default-ext<span class="token string">&quot;, &quot;</span>backend_protocol<span class="token string">&quot;, &quot;</span>HTTP<span class="token string">&quot;, &quot;</span>backend_port<span class="token string">&quot;, &quot;</span><span class="token number">80</span><span class="token string">&quot;))}&quot;</span>
    target_groups_count       = <span class="token string">&quot;1&quot;</span>
  <span class="token punctuation">}</span>

</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div></div><div class="global-ui"></div></div>
    <script src="/airship.tf/assets/js/app.4cee3cc5.js" defer></script><script src="/airship.tf/assets/js/20.c5c3716d.js" defer></script><script src="/airship.tf/assets/js/4.47100ef6.js" defer></script>
  </body>
</html>
