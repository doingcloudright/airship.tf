(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{183:function(t,s,a){"use strict";a.r(s);var n=a(18),e=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"preparation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#preparation","aria-hidden":"true"}},[t._v("#")]),t._v(" Preparation")]),t._v(" "),a("h2",{attrs:{id:"vpc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vpc","aria-hidden":"true"}},[t._v("#")]),t._v(" VPC")]),t._v(" "),a("p",[t._v("For ECS to work it needs a Virtual Private Cloud to run in, there are many proper pre-built Modules which create a VPC and everything related.\nGood examples are "),a("a",{attrs:{href:"https://github.com/cloudposse/terraform-aws-vpc",target:"_blank",rel:"noopener noreferrer"}},[t._v("Cloudposse"),a("OutboundLink")],1),t._v(" and "),a("a",{attrs:{href:"https://github.com/terraform-aws-modules/terraform-aws-vpc",target:"_blank",rel:"noopener noreferrer"}},[t._v("terraform-aws-modules"),a("OutboundLink")],1),t._v(" . For this example we use the latter. It's good practice to create public and private subnets, load balancers will reside in the public subnet, the ECS services will be in the private subnets.")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[t._v("# VPC Definition\nmodule "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"vpc"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  source  = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"terraform-aws-modules/vpc/aws"')]),t._v("\n  version = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1.46.0"')]),t._v("\n\n  name = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ecs-vpc"')]),t._v("\n  cidr = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.50.0.0/16"')]),t._v("\n\n  azs             = "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"eu-central-1a"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"eu-central-1b"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  public_subnets  = "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.50.11.0/24"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.50.12.0/24"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  private_subnets = "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.50.21.0/24"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.50.22.0/24"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n  single_nat_gateway = "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n\n  enable_nat_gateway   = "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n  enable_vpn_gateway   = "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n  enable_dns_hostnames = "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n\n  tags = "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    Terraform   = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"security-groups"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#security-groups","aria-hidden":"true"}},[t._v("#")]),t._v(" Security Groups")]),t._v(" "),a("p",[t._v("ECS will have network components just like EC2, for this example we need a security group for the load balancer, and one for the ecs service. In this example the load balancer allows traffic to HTTP and HTTPS and is allowed all outgoing traffic.")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[t._v("resource "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"aws_security_group"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lb_sg"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  name        = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"load-balancer-sg"')]),t._v("\n  description = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Allow all inbound traffic to http and https"')]),t._v("\n  vpc_id      = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${module.vpc.vpc_id}"')]),t._v("\n\n  ingress "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    from_port    = "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n    to_port      = "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n    protocol     = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tcp"')]),t._v("\n    cidr_blocks  = "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.0.0.0/0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  ingress "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    from_port    = "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("\n    to_port      = "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("\n    protocol     = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tcp"')]),t._v("\n    cidr_blocks  = "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.0.0.0/0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  egress "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    from_port   = "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n    to_port     = "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n    protocol    = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-1"')]),t._v("\n    cidr_blocks = "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.0.0.0/0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  tags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    Name = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"load-balancer-sg"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("The security group "),a("code",[t._v("fargate-ecs-service-sg")]),t._v(" only allows incoming traffic on port 80 coming from the Load Balancer security group and has no restrictions outgoing.")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[t._v("resource "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"aws_security_group"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ecs_service_sg"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  name        = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fargate-ecs-service-sg"')]),t._v("\n  description = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Allow all inbound traffic to service port"')]),t._v("\n  vpc_id      = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${module.vpc.vpc_id}"')]),t._v("\n\n  ingress "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    from_port       = "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n    to_port         = "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n    protocol        = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tcp"')]),t._v("\n    security_groups = "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${aws_security_group.lb_sg.id}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  egress "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    from_port   = "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n    to_port     = "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n    protocol    = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-1"')]),t._v("\n    cidr_blocks = "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.0.0.0/0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  tags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    Name = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fargate-ecs-service-sg"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"route53-zone"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#route53-zone","aria-hidden":"true"}},[t._v("#")]),t._v(" Route53 Zone")]),t._v(" "),a("p",[t._v("The ECS Service module by default creates a subdomain in the given zone by the following pattern [name].[domain]. This can be disabled but for this example we will use it. In the preparation step we use a datasource to make sure the zone is there.")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[t._v("data "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"aws_route53_zone"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"zone"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  name  = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"yourdomain_at_route53.com."')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"warning custom-block"},[a("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),a("p",[t._v("This module will create a record inside your existing zone, make sure that there is no overlap with existing records. If you create the certificate, it is best to use DNS validation.")])]),t._v(" "),a("h2",{attrs:{id:"application-load-balancer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#application-load-balancer","aria-hidden":"true"}},[t._v("#")]),t._v(" Application Load Balancer")]),t._v(" "),a("p",[t._v("The ECS Service module can add many ECS Services to the same Application Load Balancer (ALB) by creating hostname based listener rules. For this module to operate with an ALB we need to setup one. We setup a loggin bucket first to make sure the ALB can log to S3.")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[t._v("module "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lb_s3_bucket"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  source        = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cloudposse/lb-s3-bucket/aws"')]),t._v("\n  version       = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.1.4"')]),t._v("\n  namespace     = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dcr"')]),t._v("\n  stage         = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"test"')]),t._v("\n  name          = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lb-s3-bucket"')]),t._v("\n  region        = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<YOUR REGION>"')]),t._v("\n  force_destroy = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nmodule "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"alb_shared_services_external"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    source                    = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"terraform-aws-modules/alb/aws"')]),t._v("\n    version                   = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3.4.0"')]),t._v("\n    load_balancer_name        = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ecs-external"')]),t._v("\n    security_groups           = "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${aws_security_group.lb_sg.id}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    load_balancer_is_internal = "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    log_bucket_name           = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${module.lb_s3_bucket.bucket_id}"')]),t._v("\n    log_location_prefix       = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n    subnets                   = "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${module.vpc.public_subnets}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    tags                      = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${map("')]),t._v("Environment"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('", "')]),t._v("ECS Test Setup"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('")}"')]),t._v("\n    vpc_id                    = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${module.vpc.vpc_id}"')]),t._v("\n    https_listeners           = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n    https_listeners_count     = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0"')]),t._v("\n    http_tcp_listeners        = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${list(map("')]),t._v("port"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('", "')]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('", "')]),t._v("protocol"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('", "')]),t._v("HTTP"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"))}"')]),t._v("\n    http_tcp_listeners_count  = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),t._v("\n    target_groups             = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${list(map("')]),t._v("name"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('", "')]),t._v("default-ext"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('", "')]),t._v("backend_protocol"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('", "')]),t._v("HTTP"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('", "')]),t._v("backend_port"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('", "')]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"))}"')]),t._v("\n    target_groups_count       = "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])])])},[],!1,null,null,null);e.options.__file="preparation.md";s.default=e.exports}}]);